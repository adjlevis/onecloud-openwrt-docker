name: Build OpenWRT OneCloud

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    name: ğŸ”§ æ„å»ºå¹¶å‘å¸ƒ OneCloud OpenWRT
    runs-on: ubuntu-latest

    steps:
      # ============================================================
      # ğŸ“¦ 1. æ£€å‡ºä»“åº“ä»£ç 
      # ============================================================
      - name: ğŸ§± æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # ============================================================
      # ğŸ§° 2. å®‰è£…ä¾èµ–
      # ============================================================
      - name: ğŸ§° è®¾ç½®æ„å»ºç¯å¢ƒ
        run: |
          sudo apt update
          sudo apt install -y curl rsync git e2fsprogs dosfstools gzip tar

      # ============================================================
      # ğŸš€ 3. æ‰§è¡Œæ„å»ºè„šæœ¬
      # ============================================================
      - name: ğŸš€ è¿è¡Œ docker-build.sh
        working-directory: ./openwrt
        env:
          OP_author: ${{ github.actor }}
          OP_rootfs: 512
        run: |
          chmod +x build.sh docker-build.sh
          ./docker-build.sh

      # ============================================================
      # ğŸ“¤ 4. å‘å¸ƒæ„å»ºäº§ç‰©ï¼ˆè‡ªåŠ¨å¸¦å‘å¸ƒè¯´æ˜ï¼‰
      # ============================================================
      - name: ğŸ“¤ å‘å¸ƒæ„å»ºç»“æœ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: "OneCloud OpenWRT çº¿åˆ·åŒ…"
          files: |
            release/openwrt/*.gz
          body_path: release/openwrt/release_note.md  # âœ… è‡ªåŠ¨é™„å¸¦è¯´æ˜
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # ğŸ§¹ 5. æ¸…ç†æ—§ç‰ˆï¼Œä»…ä¿ç•™æœ€æ–°
      # ============================================================
      - name: ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬ï¼Œä»…ä¿ç•™æœ€æ–°
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ============================================================
      # âœ… 6. è¾“å‡ºå®Œæˆä¿¡æ¯
      # ============================================================
      - name: âœ… è¾“å‡ºæ„å»ºä¿¡æ¯
        run: |
          echo "ğŸ‰ æ„å»ºå¹¶å‘å¸ƒå®Œæˆï¼"
          echo "ğŸ“¦ è¾“å‡ºæ–‡ä»¶ä½äº release/openwrt/"
