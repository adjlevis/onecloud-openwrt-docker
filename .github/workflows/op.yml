name: OneCloud OpenWRT Build

on:
  # 手动触发
  workflow_dispatch:
  # 每 15 天自动触发（北京时间凌晨 3 点）
  schedule:
    - cron: "0 19 */15 * *"  # UTC+0 = 北京时间 +8 小时

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare directories
        run: |
          mkdir -p openwrt/bin openwrt/files release/openwrt

      - name: Download OpenWRT rootfs
        run: |
          ROOTFS_URL="https://dl.openwrt.ai/releases/targets/amlogic/meson8b/kwrt-10.30.2025-amlogic-meson8b-thunder-onecloud-rootfs.tar.gz"
          mkdir -p openwrt/bin/rootfs
          curl -fsSL "$ROOTFS_URL" -o openwrt/bin/rootfs/rootfs.tar.gz

      - name: Extract and modify config
        run: |
          tar -xzf openwrt/bin/rootfs/rootfs.tar.gz -C openwrt/files || true
          mkdir -p openwrt/files/etc/config
          cat > openwrt/files/etc/config/network <<'EOF'
config interface 'lan'
  option proto 'static'
  option ipaddr '192.168.2.2'
  option netmask '255.255.255.0'
  option gateway '192.168.2.1'
  option dns '192.168.2.1'
EOF
          cat > openwrt/files/etc/config/dhcp <<'EOF'
config dhcp 'lan'
  option ignore '1'
EOF

      - name: Package firmware
        run: |
          mkdir -p release/openwrt
          tar -czf release/openwrt/thunder-onecloud-rootfs-custom.tar.gz -C openwrt/files .

      - name: Get current time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "tag=$(date '+%Y.%m.%d')" >> $GITHUB_OUTPUT
          echo "time=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "OneCloud-${{ steps.time.outputs.tag }}"
          name: "OneCloud OpenWRT ${{ steps.time.outputs.tag }}"
          body: |
            ✅ 玩客云 OneCloud OpenWRT 固件构建完成
            - 平台: amlogic/meson8b
            - 内核: 6.6.110
            - 版本: openwrt.ai 24.10.4
            - 时间（北京时间）: ${{ steps.time.outputs.time }}

            固件文件：
            thunder-onecloud-rootfs-custom.tar.gz
          files: release/openwrt/thunder-onecloud-rootfs-custom.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
