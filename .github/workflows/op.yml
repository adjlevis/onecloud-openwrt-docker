name: N1 OpenWRT RootFS Custom Build

on:
  # âœ… æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      OP_author:
        description: 'ç¼–è¯‘è€…åç§°'
        required: false
        default: 'GitHub Actions'

  # âœ… æ¯ 15 å¤©è‡ªåŠ¨è§¦å‘ï¼ˆåŒ—äº¬æ—¶é—´å‡Œæ™¨ 3:00ï¼‰
  schedule:
    - cron: '0 19 */15 * *'  # UTC+0 æ—¶é—´ = åŒ—äº¬æ—¶é—´ +8 å°æ—¶

# ğŸš« ä¸ä¼šå›  push/pull_request æˆ–è„šæœ¬ä¿®æ”¹è§¦å‘
# å¦‚æœå°†æ¥æƒ³å¯ç”¨è‡ªåŠ¨è§¦å‘ï¼Œå¯å–æ¶ˆæ³¨é‡Šä»¥ä¸‹å†…å®¹ï¼š
#   push:
#     paths-ignore:
#       - '.github/workflows/**'
#       - 'openwrt/*.sh'
#   pull_request:
#     paths-ignore:
#       - '.github/workflows/**'
#       - 'openwrt/*.sh'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§± Prepare directories
        run: |
          mkdir -p openwrt/bin openwrt/files release/openwrt
          sudo chmod -R 777 openwrt/bin openwrt/files release/openwrt

      - name: ğŸ“¥ Download prebuilt rootfs
        working-directory: openwrt
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„æ„å»º rootfs æ–‡ä»¶..."
          ROOTFS_URL="https://dl.openwrt.ai/releases/targets/amlogic/meson8b/kwrt-10.30.2025-amlogic-meson8b-thunder-onecloud-rootfs.tar.gz"
          mkdir -p bin/rootfs
          cd bin/rootfs
          curl -LO "$ROOTFS_URL"
          echo "âœ… ä¸‹è½½å®Œæˆï¼š$(ls -lh)"

      - name: ğŸ“‚ Extract rootfs and apply configs
        working-directory: openwrt
        run: |
          echo "ğŸ“‚ è§£å‹ rootfs..."
          mkdir -p files/
          tar -xzf bin/rootfs/*.tar.gz -C files/ || true

          echo "ğŸ§° å†™å…¥æ—è·¯ç”±ç½‘ç»œé…ç½®..."
          mkdir -p files/etc/config

          cat <<'NETCONF' > files/etc/config/network
config interface 'lan'
  option proto 'static'
  option ipaddr '192.168.2.2'
  option netmask '255.255.255.0'
  option gateway '192.168.2.1'
  option dns '192.168.2.1'
NETCONF

          cat <<'DHCP' > files/etc/config/dhcp
config dhcp 'lan'
  option ignore '1'
DHCP

          echo "âœ… è¦†ç›–é…ç½®å®Œæˆã€‚"

      - name: ğŸ”§ Package customized firmware
        working-directory: openwrt
        run: |
          echo "ğŸ”§ æ‰“åŒ…å›ºä»¶..."
          mkdir -p ../release/openwrt
          tar -czf ../release/openwrt/thunder-onecloud-custom-rootfs.tar.gz -C files/ .
          echo "âœ… æ‰“åŒ…å®Œæˆï¼šrelease/openwrt/thunder-onecloud-custom-rootfs.tar.gz"

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: thunder-onecloud-rootfs-custom
          path: release/openwrt/
          if-no-files-found: warn
          compression-level: 6

      - name: ğŸ•’ Get Beijing Time
        id: time
        run: |
          export TZ=Asia/Shanghai
          echo "datetime=$(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

      - name: ğŸš€ Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        if: always()
        with:
          tag_name: OneCloud-OpenWRT
          name: "OneCloud OpenWRT æ—è·¯ç”±å›ºä»¶"
          body: |
            âœ… ç©å®¢äº‘ OneCloud OpenWRT å›ºä»¶æ„å»ºå®Œæˆï¼
            - å¹³å°: amlogic/meson8b
            - å†…æ ¸: 6.6.110
            - åŸºäº openwrt.ai 24.10.4
            - æ„å»ºè€…: ${{ github.event.inputs.OP_author }}
            - æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰: ${{ steps.time.outputs.datetime }}

            å›ºä»¶æ–‡ä»¶:
            ```
            thunder-onecloud-custom-rootfs.tar.gz
            ```
          files: release/openwrt/**/*
          overwrite_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
