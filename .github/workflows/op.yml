name: OneCloud OpenWRT è‡ªåŠ¨æ„å»ºçº¿åˆ·é•œåƒ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š4ç‚¹

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ ä¿®æ­£æƒé™ä¸æ¢è¡Œç¬¦
        run: |
          sudo apt-get update
          sudo apt-get install -y dos2unix
          # è½¬æ¢å¹¶èµ‹æƒ
          for f in ./openwrt/*.sh; do
            [ -f "$f" ] && dos2unix "$f" && chmod +x "$f"
          done

      - name: ğŸ§± æ‰§è¡Œæ„å»ºè„šæœ¬
        working-directory: ./openwrt
        env:
          OP_author: adjlevis
          OP_rootfs: 512
        run: |
          set -e
          echo "å¼€å§‹æ‰§è¡Œ docker-build.sh..."
          ./docker-build.sh
          echo "æ„å»ºå®Œæˆ âœ…"

      - name: ğŸ“ ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "ğŸ§¾ ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          # æ‰¾åˆ°ä¸Šä¸€ä¸ª "latest" æ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          LAST_TAG=$(git tag -l latest)
          if [ -n "$LAST_TAG" ]; then
            echo "æ£€æµ‹åˆ°æ—§ç‰ˆæœ¬ï¼Œç”Ÿæˆå˜æ›´åˆ—è¡¨..."
            git log ${LAST_TAG}..HEAD --pretty=format:"- %s" > changelog.txt
          else
            echo "é¦–æ¬¡æ„å»ºï¼Œæ˜¾ç¤ºæœ€è¿‘ 10 æ¬¡æäº¤"
            git log -n 10 --pretty=format:"- %s" > changelog.txt
          fi

          echo "------------------------"
          cat changelog.txt
          echo "------------------------"

          # å°† changelog å†…å®¹å†™å…¥ GitHub Actions è¾“å‡º
          CHANGELOG=$(cat changelog.txt)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ å‘å¸ƒ Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "latest"
          name: "OneCloud OpenWRT çº¿åˆ·åŒ…"
          body: |
            ğŸ”„ è‡ªåŠ¨æ„å»ºæ—¶é—´ï¼š${{ github.run_started_at }}
            âœ… å›ºä»¶ç±»å‹ï¼šEMMC çº¿åˆ·é•œåƒï¼ˆEXT4ï¼‰
            âš™ï¸ ä»…ä¿ç•™æœ€æ–°æ„å»ºç‰ˆæœ¬

            ğŸ†• æœ¬æ¬¡æ›´æ–°å†…å®¹ï¼š
            ${{ steps.changelog.outputs.changelog }}
          files: |
            openwrt/release/thunder-onecloud-emmc-ext4.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
